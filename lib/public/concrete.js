// Generated by CoffeeScript 1.3.0
(function() {

  $(function() {
    var addClick, closeAll, hideDuplicateMonthTags, jobTemplate, outcomeTemplate, updateJob;
    addClick = function(job) {
      return $(job).click(function(event) {
        var alreadyOpened;
        alreadyOpened = $(event.currentTarget).find('div.job_container').hasClass('open');
        closeAll();
        if (!alreadyOpened) {
          $(event.currentTarget).find('div.job_container').slideDown('fast');
          $(event.currentTarget).find('div.job_container').addClass('open');
        }
        return false;
      });
    };
    updateJob = function(job) {
      var id;
      id = $(job).find('.job_id').first().html();
      return $.get("/job/" + id, function(data) {
        $(job).find('.job_container').first().html(data.log);
        if (data.finished) {
          $(job).find('a img.loader').remove();
          $(coffeecup.render(outcomeTemplate, {
            job: data
          })).insertBefore($(job).find('.job_id'));
          $('button.build').show();
          return false;
        }
        return setTimeout(function() {
          return updateJob(job);
        }, 1000);
      }, 'json');
    };
    outcomeTemplate = function() {
      var outcomeClass;
      outcomeClass = this.job.failed ? '.failure' : '.success';
      return div(".outcome" + outcomeClass, function() {
        if (this.job.failed) {
          return '&#10008;&nbsp;failure';
        } else {
          return '&#10003;&nbsp;success';
        }
      });
    };
    jobTemplate = function() {
      return li('.job', function() {
        var d, day_time;
        d = moment(this.job.addedTime);
        day_time = d.calendar().split(' at ');
        div('.day', function() {
          return "" + day_time[0];
        });
        a({
          href: "/job/" + (this.job._id.toString())
        }, function() {
          var commit;
          div('.time', function() {
            return "" + day_time[1];
          });
          if (commit = this.job.commit) {
            div('.commit_details', function() {
              span('.commit-sha', function() {
                return '' + commit.sha + ' ';
              });
              span('.commit-message', function() {
                return commit.message;
              });
              return span('.commit-time', function() {
                return " (" + moment(commit.time).fromNow() + ")";
              });
            });
          }
          img('.loader', {
            src: 'images/spinner.gif'
          });
          return div('.job_id', function() {
            return "" + (this.job._id.toString());
          });
        });
        return div('.job_container', function() {
          return this.job.log;
        });
      });
    };
    closeAll = function() {
      var container, opened, _i, _len, _results;
      opened = $('li.job').find('div.job_container.open');
      _results = [];
      for (_i = 0, _len = opened.length; _i < _len; _i++) {
        container = opened[_i];
        $(container).slideUp('fast');
        _results.push($(container).removeClass('open'));
      }
      return _results;
    };
    $('button.build').click(function(event) {
      closeAll();
      $('button.build').hide();
      $('li.nojob').hide();
      $.post('/', function(data) {
        var job;
        if ($('ul.jobs').find('li.nojob').length > 0) {
          $('ul.jobs').find('li.nojob').first().remove();
        }
        job = $('ul.jobs').prepend(coffeecup.render(jobTemplate, {
          job: data
        }));
        job = $(job).find('li').first();
        addClick(job);
        updateJob(job);
        hideDuplicateMonthTags();
        return $(job).find('.job_container').click();
      }, 'json');
      return false;
    });
    $('li.job').each(function(iterator, job) {
      return addClick(job);
    });
    hideDuplicateMonthTags = function() {
      var lastText;
      lastText = '';
      return $('.day').each(function(iterator, dateDiv) {
        var $dateDiv;
        $dateDiv = $(dateDiv);
        if (lastText === $dateDiv.text()) {
          return $dateDiv.hide();
        } else {
          return lastText = $dateDiv.text();
        }
      });
    };
    return hideDuplicateMonthTags();
  });

}).call(this);
